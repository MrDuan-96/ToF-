# OPT3101 #
## 0.ToF原理 ##
- ToF即Time of fight(飞行时间)。通过**给目标持续发送光脉冲**，然后用传感器**接收从物体返回的光**，通过测量光的飞行实际来得到**目标之间的距离**。
- ToF的发射单元目前有两种解决方案：**光学快门** 和 **连续波强度调制**
- **光学快门** ： 发射一束脉冲光波，通过光学快门快速精确获取照射到三维物体后反射回来的光波的时间差t，由于光速c已知，只要知道照射光和接收光的时间差，来回的距离可以通过公示d = t/2· c。 此种方法原理看起来非常简单，但是实际应用中要达到较高的精度仍具有很大的挑战，如控制光学快门开关的时钟要求非常高的精度，还要能够产生高精度及高重复性的超短脉冲，照射单元和ToF传感器都需要高速信号控制，这样才能达到高的深度测量精度。 假如照射光与ToF传感器之间的时钟信号发生10ps的偏移，就相当于1.5mm的位移误差。
- **连续波强度调制** ：发射一束照明光，利用发射光波信号与反射光波信号的相位变化来进行距离测量。其中，照明模组的波长一般是红外波段，且需要进行高频率调制。ToF感光模组与普通手机摄像模组类似，由芯片，镜头，线路板等部件构成，ToF感光芯片每一个像元对发射光波的往返相机与物体之间的具体相位分别进行录，通过数据处理单元提取出相位差，由公式计算出深度信息。该芯片传感器结构与普通手机摄像模组所采用的CMOS图像传感器类似，但更复杂一些，它包含调制控制单元，A/D转换单元，数据处理单元等，因此ToF芯片像素比一般图像传感器像素尺寸要大得多，一般20um左右。也需要一个搜集光线的镜头，不过与普通光学镜头不同的是这里需要加一个红外带通滤光片来保证只有与照明光源波长相同的光才能进入。由于光学成像系统不同距离的场景为各个不同直径的同心球面，而非平行平面，所以在实际使用时，需要后续数据处理单元对这个误差进行校正。ToF相机的校正是生产制程中必不可少的最重要的工序，没有校正工序，ToF相机就无法正常工作。
- [参考资料](https://blog.csdn.net/zhy295006359/article/details/80205165 "参考资料" )

## 1.概述 ##
- OPT3101是TI推出的一款基于ToF原理的单点ToF AFE(模拟前端)。其通过外接一个发射管LED来发送调制光信号到目标物体，然后再经过一个外接光电二极管来接收反射调制光信号。经过OPT3101内部的ADC和景深/距离处理单元等处理计算，得到精确的目标景深/距离/光强度等信息。
## 2.工作原理 ##
[![0ezVds.jpg](https://s1.ax1x.com/2020/09/29/0ezVds.jpg)](https://imgchr.com/i/0ezVds)

- OPT3101 是高速、高精度的单点 ToF 的模拟前端 AFE（算法基于连续调制波），用来接近感应和目标物
体的距离探测。
- 系统只需要连接外部的光源发射调制光信号，和
外部的光电二极管 Photodiode 接收发射光到芯片输入端。
- 系统集成了较高的环境光抑制能力，芯片能够在较强的光照强度下（130Klux），甚至100倍于信号强度（200uA 环境光 vs 200nA 的信号强度） 。芯片输出数据中包含 16bit 的 Phase（景深/距离）数据、 15bit 的接收反射光强度数据和 9bit 的环境光强度数据，通过 I2C 接口（Slave） 输出。 芯片另一个 I2C 接口（Master）是接外部温度传感器（若需要，芯片本身已有集成了温度传感器） ，用来做温度校正功能。
- OPT3101 没有集成接收光电二极管，所以没有集成 Integration 时间一说，只有曝光时间。固定曝光时间250us，在该时间内，OPT3101的AFE（模拟前端）一直处于工作状态，用来实时检测和计算发射调制光和反射光的相位差，该时间也是OPT3101产生一个有效Phase输出和Amplitude（振幅）接收光强度所需要的最小时间，因此最大为4Khz的子帧率。
- 如果在曝光时间内OPT3101的AFE（模拟前端）接收的电流过大，那么芯片AFE的电压会饱和并且不会输出正确的测量值。（该帧也会被 flag 标识为饱和帧）
- 当需要不同帧率时，多个子帧的计算结果可以内部平均，从而输出一个结果。举例说明，若使用 2^7（128）
个子帧，也就是帧率 4000/2^7=31.25 fps(frames per second)，那么 OPT3101 会每帧产生一个由 128 个
子帧的结果平均得到的数值。这样做的好处是减少噪声水平。相对于 4KHz 帧率（即每子帧产生一个结果）
情况， 噪音水平理论上可以提升 sqrt(2^7)=11 倍左右。


## 3.LED驱动电路 ##

 - OPT3101 集成的发射管 LED 驱动电路，可以驱动最多 3 个通道 TX0~2，同个时间段只能驱动一个通道的 LED。 驱动电流的大小通过上述的寄存器 ILLUM_DAC_H/L 的设置， 5bit 共 32 个 Step 选择。每个 Step 的幅度由 ILLUM_CURR_SCALE 寄存器来设置（从 0.1mA 到 5mA）。最大驱动电流为155mA。
 
 [![0M3aPH.jpg](https://s1.ax1x.com/2020/10/01/0M3aPH.jpg)](https://imgchr.com/i/0M3aPH)

 - 另外该电路提供电流的直流偏置选项，由寄存器 ILLUM_DC_BIAS_PROG 来设置，从 0.75mA 到 7.5mA。
 若应用只需要较小的 LED 驱动电流，那么直流偏置可以提供更快的开启时间（LED 不用等待 Mos 管从关
 闭到打开的时间）。
[![0M3xQ1.jpg](https://s1.ax1x.com/2020/10/01/0M3xQ1.jpg)](https://imgchr.com/i/0M3xQ1)

## 4.工作模式 ##
- OPT3101 有不同的工作模式，可分为连续模式和单次模   式，非 HDR 模式和 HDR(High Dynamic Range 高
动态范围)模式，以及单 LED 工作模式和多 LED 工作模式。
- 传统的HDR模式是调整芯片的AFE的接受增益gain，从而避免饱和情况，而OPT3101不是调整AFE的增益gain，而是调整发射管LED的驱动电流大小。这样做的好处是，降低系统的整体功耗（对高反射性目标物体，LED发射管功耗可以显著降低）和更好控制crosstalk串扰噪声。（crosstalk 依赖于 AFE 的增益 gain，而固定 gain 有助于 crosstalk 校正）。

### Non-HDR ###
- 在该模式下，LED的驱动电流大小恒定。每个帧可以分解成若干个子帧，每一帧的子帧数量可以设置为1到2的12次方（1-4096）。每个子帧有10000个时钟，相当于4KHz的子帧率。其中8192个时钟是光电二极管的信号采集时间，剩下的是信号处理时间。

![0Mnk79.jpg](https://s1.ax1x.com/2020/10/01/0Mnk79.jpg)

当设置 SUB_FRAME_CNT 为 0 时，也就是每一帧就是一个子帧，那么最高的帧率亦即 4KHz。公式 1 表
明了如何设定所需的帧率。

[![0M9QmV.md.jpg](https://s1.ax1x.com/2020/10/01/0M9QmV.md.jpg)](https://imgchr.com/i/0M9QmV)

### Auto-HDR ###

 - 在该模式下，根据接收光的饱和以及接收光强度Amplitude 的预设值，时序会在 2 种 LED 驱动电流的情况下自动互相切换（无需软件介入）， 从而拓展 OPT3101 的测量范围。

 - 如下图三， 预设 2 个驱动电流—大驱动电流工况和小驱动电流工况。当工作在大驱动电流（以下简称大电流） 工况下，若接收反射光强度 Amplitude 超过芯片饱和阀值，则会自动切换到小驱动电流（以下简称小电流）工况。当工作在小电流工况下，若接收反射光强度 Amplitude 低于预设的阀值（测量精度/可信度已经得不到保证），则自动切换到大电流工况。设置大小电流之间的需要留出足够余量， 以避免频繁的来回切换。

[![0M9zAU.md.jpg](https://s1.ax1x.com/2020/10/01/0M9zAU.md.jpg)](https://imgchr.com/i/0M9zAU)

 - HDR模式中，时序会有些不同。如下图所示，在每一帧内，第一个子帧时间是用来决定后续电流DAC大小，若第一个子帧输出以及接受光强度满足原条件，则 ILLUM_DAC 不修改，若不满足，则 ILLMU_DAC 切换到第一个 DAC 预设值。由于第一个子帧得到的数据不参与实际计算，所以实际的接收光强度 Amplitude=期望的Amplitude*SUB_FRAME_CNT/SUB_FRAME_CNT+1。
 （接收到的实际光强 = （期望的光强 * 子帧的数量）/(子帧的数量 + 1)）
 [![0MMt91.jpg](https://s1.ax1x.com/2020/10/01/0MMt91.jpg)](https://imgchr.com/i/0MMt91)
 - 接收反射光强度 Amplitude 的阀值设置应该满足下面公式
![0MQhxx.jpg](https://s1.ax1x.com/2020/10/01/0MQhxx.jpg)

 - HDR_TH_HIGH 是 OPT3101 的接收光强度 Amplitude 的饱和阀值，应该设置略低于实际的饱和值。
 HDR_TH_LOW 是满足精度要求下的最低阀值，应该设置略高于实际的最低阀值
 - 下图是 Auto-HDR 工作模式的一个实际测试波形。横坐标是目标物体的距离（离发射/接收管），纵坐标
 是接收光强度 Amplitude，用 dBFS 单位表征。 可以看到，当目标很近时用小电流，接收光 Amplitude 接近
 0dBFS，而随着目标逐渐远离， Amplitude 逐步下降，当到 480mm 时， HDR 自动切换到大电流，此时接
 收光的 Amplitude 恢复到较大的水平（需注意不能到饱和点） ，而后随着进一步远离到更远时，接收光
 Amplitude 也逐渐下降，直至该设计的最远量程（即 Amplitude 降低到已经不能保证 Phase 精度的水平）。
 
[![0M1inK.jpg](https://s1.ax1x.com/2020/10/01/0M1inK.jpg)](https://imgchr.com/i/0M1inK)

 
### Super-HDR ###

 - Auto HDR 模式一定程度上拓展了测量动态范围， 如上节说到， 达到最大 31 倍的大小电流。 但在有些应用场景，如需要测量更宽的探测距离，或者测量目标区域有高反射性物体（反光牌等），大小 2 个驱动电流的就不够满足所需的动态范围。此时就需要进一步扩展 OPT3101 的动态范围， 比如 62 倍(36db)或更大。实现方法是设置 2 组 ILLUM_DAC_H/L，然后先用软件做“软件”阀值判定、切换， 接着进入各组的Auto-HDR 模式内。
 - 通过这种 Super HDR 工作方式，相当于实现了内外 2 个循环，外循环即软件阀值切换，内循环即自动HDR 的切换，从而让 OPT3101 的驱动电流范围进一步的扩大成为可能，也就极大地拓展了芯片的测量动态范围。

